#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <time.h>

int lines_num(FILE *file);

int printIndex(char *str, char *s);

int main(void)
{
    char *modes[3] = { "animals.txt", "englit.txt", "hardwords.txt" };

    const char *text =
    " _    _ \n"
    "| |  | | \n"
    "| |__| | __ _ _ __   __ _ _ __ ___   __ _ _ __  \n"
    "|  __  |/ _` | '_ \\ / _` | '_ ` _ \\ / _` | '_ \\ \n"
    "| |  | | (_| | | | | (_| | | | | | | (_| | | | | \n"
    "|_|  |_|\\__,_|_| |_|\\__, |_| |_| |_|\\__,_|_| |_| \n"
    "                     __/ | \n"
    "                    |___/  \n";

    const char *pics[7] =
    {
    "+---+ \n"
    "|   | \n"
    "    | \n"
    "    | \n"
    "    | \n"
    "    | \n"
   "========\n",
    "+---+ \n"
    "|   | \n"
    "O   | \n"
    "    | \n"
    "    | \n"
    "    | \n"
   "========\n",
    "+---+ \n"
    "|   | \n"
    "O   | \n"
    "|   | \n"
    "    | \n"
    "    | \n"
   "========\n",
    "+---+ \n"
    "|   | \n"
    "O   | \n"
   "/|   | \n"
    "    | \n"
    "    | \n"
   "========\n",
    "+---+ \n"
    "|   | \n"
    "O   | \n"
   "/|\\  | \n"
    "    | \n"
    "    | \n"
   "========\n",
    "+---+ \n"
    "|   | \n"
    "O   | \n"
   "/|\\  | \n"
   "/    | \n"
    "    | \n"
   "========\n",
    "+---+ \n"
    "|   | \n"
    "O   | \n"
   "/|\\  | \n"
   "/ \\  | \n"
    "    | \n"
   "========\n"
    };

    printf("%s\n", text);

    printf("Welcome to hangman. Choose your category: \n");
    printf("Animals\nLiterature\nDifficult\n");

    char category[20];
    scanf("%s", category);

    FILE *inptr;

    if (strncmp(category, "Ani", 7) == 0) {
        inptr = fopen("animals.txt", "r");
    } else if (strncmp(category, "Lit", 18) == 0) {
        inptr = fopen("englit.txt", "r");
    } else if (strncmp(category, "Diff", 15) == 0) {
        inptr = fopen("hardwords.txt", "r");
    } else {
        fprintf(stderr, "Error. Please choose one of the categories listed.");
        return 1;
    }

    int number_of_lines = lines_num(inptr);

    if (inptr == NULL)
    {
        fprintf(stderr, "There was an error.\n");
        return 2;
    }

    char temp_word[80];
    char word[50];

    srand(time(0));
    int rand_num = rand() % number_of_lines;

    fseek(inptr, 0, SEEK_SET);

    for (int i = 0; i <= number_of_lines + 1; i++)
    {
        fseek(inptr, 0, SEEK_CUR);

        if (i == rand_num)
        {
            strcpy(word, temp_word);
            break;
        }

        fgets(temp_word, 70, inptr);

    }

    char guess_word[70] = "";

    for (int j = 0, n = strlen(word); j < n; j++)
    {
        if (isalpha(word[j]))
        {
            strcat(guess_word, "_");
        }
        else
        {
            strcat(guess_word, " ");
        }
    }

    printf("%s\n", guess_word);

    char input[2];
    while (strcmp(word, guess_word) != 0)
    {
        printf("Enter a letter to guess: (case-insensitive)\n");
        scanf("%s", input);

        char * pch;

        pch = strcasestr(word, input);

        while (pch != NULL)
        {
            //printf ("%c " , *pch);
            //printf ("found at index %ld\n", pch-word);
            pch = strcasestr(pch+1,input);
        }

        for (int i = 0; i < strlen(word); i++)
        {
            if (tolower(word[i]) == input[0])
            {
                if (guess_word[i] == input[0])
                {
                    printf("Already guessed.\n");
                    //return 1;
                }
                guess_word[i] = word[i];
                printf("%s\n", guess_word);
            }
        }
    }

    return 0;
}

int lines_num(FILE *file) {
    int ch;
    int number_of_lines = 0;

    while (EOF != (ch=getc(file)))
    {
        if ('\n' == ch)
        {
            ++number_of_lines;
        }
    }

    return number_of_lines;
}
